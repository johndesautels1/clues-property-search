# CLUES Property Search - Timeouts & Firing Order Master Reference

## Quick Reference Table

| Tier | Source | Timeout | Firing Order | File(s) |
|------|--------|---------|--------------|---------|
| 1 | Stellar MLS (Bridge API) | 15s | 1st | search.ts, search-by-mls.ts |
| 2 | Google Geocoding | 60s | 2nd | search.ts |
| 2 | Google Places | 60s | 2nd | search.ts |
| 2 | Google Distance Matrix | 60s | 2nd | search.ts |
| 3 | SchoolDigger | 60s | 3rd (parallel) | search.ts |
| 3 | FBI Crime | 60s | 3rd (parallel) | search.ts |
| 3 | WalkScore | 60s | 3rd (parallel) | search.ts |
| 3 | FEMA NFHL | 60s | 3rd (parallel) | search.ts |
| 3 | AirNow | 60s | 3rd (parallel) | search.ts |
| 3 | HowLoud | 60s | 3rd (parallel) | search.ts |
| 3 | OpenWeatherMap | 60s | 3rd (parallel) | search.ts |
| 3 | U.S. Census | 60s | 3rd (parallel) | search.ts |
| 3 | **Tavily Web Search** | **15s** | 3rd (after Free APIs) | search.ts, tavily-search.ts |
| 4 | Perplexity | 45s | 4th - LLM #1 | search.ts, retry-llm.ts, perplexity-prompts.ts |
| 4 | Gemini | 180s | 5th - LLM #2 | search.ts, retry-llm.ts, gemini-prompts.ts |
| 4 | GPT-4o | 180s | 6th - LLM #3 | search.ts, retry-llm.ts |
| 4 | Claude Sonnet | 180s | 7th - LLM #4 | search.ts, retry-llm.ts |
| 4 | Grok | 180s | 8th - LLM #5 | search.ts, retry-llm.ts |
| 5 | Claude Opus | 180s | 9th - LLM #6 (LAST) | search.ts, retry-llm.ts |

## Vercel Serverless Config

| File | maxDuration |
|------|-------------|
| search.ts | 300s (5 min) |
| search-by-mls.ts | 300s (5 min) |
| search-stream.ts | 300s (5 min) |
| retry-llm.ts | 300s (5 min) |

## Timeout Constants by File

### search.ts (Main Orchestrator)
```typescript
const STELLAR_MLS_TIMEOUT = 15000;   // 15s - Tier 1
const FREE_API_TIMEOUT = 60000;       // 60s - Tier 2 & 3 Free APIs
const TAVILY_TIMEOUT = 15000;         // 15s - Tier 3 Tavily
const PERPLEXITY_TIMEOUT = 45000;     // 45s - Tier 4 LLM #1
const LLM_TIMEOUT = 180000;           // 180s - Tier 4-5 LLMs #2-6
```

### retry-llm.ts (Single LLM Retry)
```typescript
const LLM_TIMEOUT = 180000;           // 180s - GPT, Gemini, Sonnet, Grok, Opus
const PERPLEXITY_TIMEOUT = 45000;     // 45s - Perplexity
```

### search-by-mls.ts (MLS-First Flow)
```typescript
const BRIDGE_MLS_TIMEOUT = 15000;     // 15s - Bridge API
```

### tavily-search.ts (Tavily Client)
```typescript
TAVILY_CONFIG.timeout = 15000;        // 15s
```

### llm-constants.ts (Central Config)
```typescript
TAVILY_CONFIG.timeout = 15000;        // 15s
```

---

## Complete Firing Order Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CLUES PROPERTY SEARCH - COMPLETE DATA FLOW                   â”‚
â”‚                         Total Budget: 300s (5 minutes)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TIME    TIER    SOURCE                  TIMEOUT    EXECUTION MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

t=0s    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ TIER 1: STELLAR MLS (Bridge Interactive API)                            â”‚
        â”‚ Timeout: 15s â”‚ Files: search.ts:4807, search-by-mls.ts:30              â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ â€¢ Query by MLS# or Address                                              â”‚
        â”‚ â€¢ Returns: 60+ fields (basics, HOA, taxes, features)                    â”‚
        â”‚ â€¢ Source name: "Stellar MLS"                                            â”‚
        â”‚ â€¢ Execution: SEQUENTIAL (must complete before Tier 2)                   â”‚
t=15s   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
t=15s   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ TIER 2: GOOGLE APIs                                                     â”‚
        â”‚ Timeout: 60s (shared) â”‚ File: search.ts                                â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Parallel Execution:                                                     â”‚
        â”‚ â”œâ”€ Google Geocoding â†’ lat/lon, formatted address                       â”‚
        â”‚ â”œâ”€ Google Places â†’ POI distances (grocery, hospital, park, beach)      â”‚
        â”‚ â””â”€ Google Distance Matrix â†’ commute times, transit access              â”‚
        â”‚ â€¢ Source names: "Google Geocode", "Google Places", "Google Distance"   â”‚
t=75s   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
t=75s   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ TIER 3: FREE APIs (Parallel)                                            â”‚
        â”‚ Timeout: 60s â”‚ File: search.ts:5016-5021                               â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ All execute in parallel via Promise.all():                              â”‚
        â”‚ â”œâ”€ SchoolDigger      â†’ school assignments, ratings (63, 65-73)         â”‚
        â”‚ â”œâ”€ FBI Crime         â†’ crime indices (88-90)                            â”‚
        â”‚ â”œâ”€ WalkScore         â†’ walk/transit/bike scores (74-80)                â”‚
        â”‚ â”œâ”€ FEMA NFHL         â†’ flood zone (119-120)                            â”‚
        â”‚ â”œâ”€ AirNow            â†’ air quality (117-118)                           â”‚
        â”‚ â”œâ”€ HowLoud           â†’ noise level (78, 129)                           â”‚
        â”‚ â”œâ”€ OpenWeatherMap    â†’ climate data (121)                              â”‚
        â”‚ â””â”€ U.S. Census       â†’ demographics                                    â”‚
t=135s  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
t=135s  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ TIER 3 (continued): TAVILY WEB SEARCH                                   â”‚
        â”‚ Timeout: 15s â”‚ Files: search.ts:5117-5147, tavily-search.ts            â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Parallel searches via Promise.all():                                    â”‚
        â”‚ â”œâ”€ searchAVMs(address)                                                  â”‚
        â”‚ â”‚   â””â”€ site:zillow.com â†’ 16a_zestimate                                 â”‚
        â”‚ â”‚   â””â”€ site:redfin.com â†’ 16b_redfin_estimate                           â”‚
        â”‚ â”œâ”€ searchMarketStats(city, zip)                                        â”‚
        â”‚ â”‚   â””â”€ 91_median_home_price, 92_price_per_sqft, 95_days_on_market      â”‚
        â”‚ â”œâ”€ searchUtilities(city, state)                                        â”‚
        â”‚ â”‚   â””â”€ 104_electric, 106_water, 109_natural_gas                        â”‚
        â”‚ â”œâ”€ searchPermits(address, county)                                      â”‚
        â”‚ â”‚   â””â”€ 60_permit_roof, 61_permit_hvac                                  â”‚
        â”‚ â””â”€ searchPortalViews(address)                                          â”‚
        â”‚     â””â”€ 169-172_views, 174_saves_favorites                              â”‚
        â”‚ â€¢ Source name: "Tavily", "Tavily (Zillow)", "Tavily (Redfin)"          â”‚
t=150s  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    TIER 4: LLM CASCADE (Web-Search Enabled)
                    Total LLM Budget: ~150s remaining
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                        â”‚
                                        â–¼
t=150s  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ LLM #1: PERPLEXITY (sonar-reasoning-pro)                                â”‚
        â”‚ Timeout: 45s â”‚ Files: search.ts:5256, retry-llm.ts:1612                â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Prompt Context:                                                         â”‚
        â”‚ "ğŸ”´ FIRING ORDER: You are the FIRST LLM in the search chain (Tier 4).  â”‚
        â”‚  PRIOR DATA SOURCES (Tier 3 - already ran BEFORE you):                 â”‚
        â”‚  - Tavily Web Search, SchoolDigger, FBI Crime, WalkScore, FEMA..."     â”‚
        â”‚                                                                         â”‚
        â”‚ Micro-prompts A-F:                                                      â”‚
        â”‚ â”œâ”€ A: Listing portals, AVMs, neighborhood pricing                      â”‚
        â”‚ â”œâ”€ B: County records, permits, legal                                   â”‚
        â”‚ â”œâ”€ C: Schools, walkability, crime                                      â”‚
        â”‚ â”œâ”€ D: Utilities, connectivity, structure ages                          â”‚
        â”‚ â”œâ”€ E: Comparable sales, financing                                      â”‚
        â”‚ â””â”€ F: EV charging, smart home, views/saves                             â”‚
        â”‚ â€¢ Source name: "Perplexity"                                            â”‚
t=195s  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
t=195s  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ LLM #2: GEMINI (gemini-3-pro + Google Search)                   â”‚
        â”‚ Timeout: 180s â”‚ Files: search.ts:5286, gemini-prompts.ts               â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ Prompt Context:                                                         â”‚
        â”‚ "ğŸŸ¡ FIRING ORDER: You are the 3rd data source in the search chain.     â”‚
        â”‚  TIER 3 DATA SOURCES (already ran BEFORE you):                         â”‚
        â”‚  - Tavily Web Search, Free APIs..."                                    â”‚
        â”‚                                                                         â”‚
        â”‚ â€¢ Uses Google Search grounding tool                                     â”‚
        â”‚ â€¢ 47 high-velocity fields                                              â”‚
        â”‚ â€¢ Source name: "Gemini"                                                â”‚
t=375s  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                            (Cascade continues if time permits)
                                        â”‚
                                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ LLM #3: GPT-4o (+ web_search tool)                                      â”‚
        â”‚ Timeout: 180s â”‚ File: search.ts                                        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ "ğŸŸ  FIRING ORDER: 3rd LLM in chain (after Perplexity â†’ Gemini).        â”‚
        â”‚  PRIOR: Tier 3 + Perplexity, Gemini"                                   â”‚
        â”‚ â€¢ Uses OpenAI Responses API with web_search                            â”‚
        â”‚ â€¢ Source name: "GPT" or "GPT-4o"                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ LLM #4: CLAUDE SONNET (claude-sonnet-4-5 + web_search beta)             â”‚
        â”‚ Timeout: 180s â”‚ File: search.ts                                        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ "ğŸ”µ FIRING ORDER: 4th LLM in chain. Grok and Opus fire AFTER.          â”‚
        â”‚  PRIOR: Tier 3 + Perplexity, Gemini, GPT"                              â”‚
        â”‚ â€¢ Uses Anthropic web_search beta tool                                   â”‚
        â”‚ â€¢ Source name: "Claude Sonnet"                                         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ LLM #5: GROK (grok-4-1-fast)                                            â”‚
        â”‚ Timeout: 180s â”‚ File: search.ts                                        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ "ğŸŸ£ FIRING ORDER: 5th LLM in chain.                                    â”‚
        â”‚  PRIOR: Tier 3 + Perplexity, Gemini, GPT, Claude Sonnet"               â”‚
        â”‚ â€¢ Uses Tavily as web search backend for tool calls                     â”‚
        â”‚ â€¢ Source name: "Grok"                                                  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    TIER 5: CLAUDE OPUS (No Web Search)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                                        â”‚
                                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ LLM #6: CLAUDE OPUS (claude-opus-4-5 - NO WEB ACCESS)                   â”‚
        â”‚ Timeout: 180s â”‚ File: search.ts                                        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ "âš« FIRING ORDER: 6th and FINAL LLM in chain.                          â”‚
        â”‚  PRIOR: Tier 3 + ALL 5 Tier 4 LLMs"                                    â”‚
        â”‚                                                                         â”‚
        â”‚ â€¢ NO web search capability                                              â”‚
        â”‚ â€¢ Uses training knowledge only                                          â”‚
        â”‚ â€¢ Fires LAST as final fallback                                         â”‚
        â”‚ â€¢ Forbidden from guessing live market data                             â”‚
        â”‚ â€¢ Source name: "Claude Opus"                                           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ FINAL OUTPUT: arbitrationPipeline.getResult()                          â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ {                                                                       â”‚
        â”‚   fields: { [key]: { value, source, confidence } },                    â”‚
        â”‚   source_breakdown: {                                                  â”‚
        â”‚     "Stellar MLS": 45,                                                 â”‚
        â”‚     "Google Places": 8,                                                â”‚
        â”‚     "Tavily": 6,                                                       â”‚
        â”‚     "Perplexity": 12,                                                  â”‚
        â”‚     "Gemini": 8,                                                       â”‚
        â”‚     ...                                                                â”‚
        â”‚   },                                                                   â”‚
        â”‚   total_fields_found: 138                                              â”‚
        â”‚ }                                                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Cross-Reference Matrix

| Source | search.ts | retry-llm.ts | search-by-mls.ts | search-stream.ts | tavily-search.ts | llm-constants.ts | source-constants.ts | perplexity-prompts.ts | gemini-prompts.ts |
|--------|-----------|--------------|------------------|------------------|------------------|------------------|---------------------|----------------------|-------------------|
| Stellar MLS | âœ“ (15s) | - | âœ“ (15s) | âœ“ | - | - | âœ“ | - | - |
| Google Geocode | âœ“ (60s) | - | - | âœ“ | - | - | - | - | - |
| Google Places | âœ“ (60s) | - | - | âœ“ | - | - | - | - | - |
| Google Distance | âœ“ (60s) | - | - | âœ“ | - | - | - | - | - |
| SchoolDigger | âœ“ (60s) | - | - | âœ“ | - | - | - | - | - |
| FBI Crime | âœ“ (60s) | - | - | âœ“ | - | - | âœ“ | - | - |
| WalkScore | âœ“ (60s) | - | - | âœ“ | - | - | - | - | - |
| FEMA | âœ“ (60s) | - | - | âœ“ | - | - | - | - | - |
| AirNow | âœ“ (60s) | - | - | âœ“ | - | - | - | - | - |
| HowLoud | âœ“ (60s) | - | - | âœ“ | - | - | - | - | - |
| Weather | âœ“ (60s) | - | - | âœ“ | - | - | - | - | - |
| Census | âœ“ (60s) | - | - | âœ“ | - | - | - | - | - |
| **Tavily** | **âœ“ (15s)** | **âœ“** | - | **âœ“** | **âœ“ (15s)** | **âœ“ (15s)** | **âœ“** | **âœ“** | **âœ“** |
| Perplexity | âœ“ (45s) | âœ“ (45s) | - | âœ“ | - | - | - | âœ“ | - |
| Gemini | âœ“ (180s) | âœ“ (180s) | - | âœ“ | - | - | - | - | âœ“ |
| GPT | âœ“ (180s) | âœ“ (180s) | - | âœ“ | - | - | - | - | - |
| Claude Sonnet | âœ“ (180s) | âœ“ (180s) | - | âœ“ | - | - | - | - | - |
| Grok | âœ“ (180s) | âœ“ (180s) | - | âœ“ | - | - | - | - | - |
| Claude Opus | âœ“ (180s) | âœ“ (180s) | - | âœ“ | - | - | - | - | - |

---

## Timeout Summary by Tier

| Tier | Sources | Individual Timeout | Execution Mode | Max Tier Time |
|------|---------|-------------------|----------------|---------------|
| 1 | Stellar MLS | 15s | Sequential | 15s |
| 2 | Google APIs (3) | 60s each | Parallel | 60s |
| 3 | Free APIs (8) | 60s each | Parallel | 60s |
| 3 | Tavily | 15s | Sequential (after Free) | 15s |
| 4 | Perplexity | 45s | Sequential | 45s |
| 4 | Gemini | 180s | Sequential | 180s |
| 4 | GPT | 180s | Sequential | 180s |
| 4 | Claude Sonnet | 180s | Sequential | 180s |
| 4 | Grok | 180s | Sequential | 180s |
| 5 | Claude Opus | 180s | Sequential | 180s |

**Note:** In practice, LLMs typically respond in 20-60s. The cascade exits early when sufficient fields are found.

---

## LLM Prompt Firing Order Context

Each LLM prompt now includes explicit firing order awareness:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PERPLEXITY (LLM #1):                                            â”‚
â”‚ "ğŸ”´ FIRING ORDER: You are the FIRST LLM (Tier 4).              â”‚
â”‚  PRIOR: Tier 3 (Tavily, Free APIs)"                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GEMINI (LLM #2):                                                â”‚
â”‚ "ğŸŸ¡ FIRING ORDER: You are the 3rd data source.                 â”‚
â”‚  PRIOR: Tier 3 (Tavily, Free APIs)"                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GPT (LLM #3):                                                   â”‚
â”‚ "ğŸŸ  FIRING ORDER: 3rd LLM (after Perplexity â†’ Gemini).         â”‚
â”‚  PRIOR: Tier 3 + Perplexity, Gemini"                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CLAUDE SONNET (LLM #4):                                         â”‚
â”‚ "ğŸ”µ FIRING ORDER: 4th LLM. Grok and Opus fire AFTER.           â”‚
â”‚  PRIOR: Tier 3 + Perplexity, Gemini, GPT"                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GROK (LLM #5):                                                  â”‚
â”‚ "ğŸŸ£ FIRING ORDER: 5th LLM.                                     â”‚
â”‚  PRIOR: Tier 3 + Perplexity, Gemini, GPT, Sonnet"              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CLAUDE OPUS (LLM #6):                                           â”‚
â”‚ "âš« FIRING ORDER: 6th and FINAL. NO web search.                â”‚
â”‚  PRIOR: Tier 3 + ALL 5 Tier 4 LLMs"                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Updated: 2026-01-08

Files involved in Tavily integration:
1. api/property/tavily-search.ts (NEW)
2. api/property/search.ts
3. api/property/retry-llm.ts
4. api/property/search-by-mls.ts
5. api/property/search-stream.ts
6. api/property/source-constants.ts
7. api/property/llm-constants.ts
8. api/property/perplexity-prompts.ts
9. src/config/gemini-prompts.ts
10. src/lib/field-normalizer.ts
